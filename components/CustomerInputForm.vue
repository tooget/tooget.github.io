<template>
  <section class="my-8">
    <div class="text-center">
      <h1 class="mb-6">Ask Me Anything</h1>
    </div>

    <form method="post" @submit="checkForm">
      <div class="mb-4">
        <label for="name">Name:</label>
        <input
          v-model="name"
          type="text"
          name="name"
          placeholder="Your Name"
          class="block mt-2 bg-gray-200 rounded w-full py-2 px-3"
        />
      </div>
      <div class="mb-4">
        <label for="mail">Email:</label>
        <input
          v-model="email"
          type="email"
          name="email"
          placeholder="Your Email"
          class="block mt-2 bg-gray-200 rounded w-full py-2 px-3"
        />
      </div>
      <div class="mb-4">
        <label for="msg">Message:</label>
        <textarea
          v-model="message"
          name="message"
          placeholder="Your Message"
          class="block mt-2 bg-gray-200 rounded w-full py-2 px-3"
        ></textarea>
      </div>
      <div class="mb-4">
        <input
          type="submit"
          value="Send message"
          :class="{ 'cursor-not-allowed opacity-50': loading }"
          class="
            cursor-pointer
            bg-blue-500
            hover:bg-blue-400
            text-white
            font-bold
            py-2
            px-4
            border-b-4 border-blue-600
            hover:border-blue-500
            rounded
          "
        />
      </div>
      <div v-if="errors.length" class="mb-4 text-red-500">
        <b>Please correct the following error(s):</b>
        <ul>
          <li v-for="error in errors" :key="error">
            {{ error }}
          </li>
        </ul>
      </div>
      <div v-if="success" class="text-green-500">
        <b>Your message has been sent succesfully</b>
      </div>
    </form>
  </section>
</template>

<script>
export default {

  data () {
    return {
      errors: [],
      name: null,
      email: null,
      message: null,
      loading: false,
      success: false
    }
  },
  head () {
    return {
      title: 'Ask Me Anything',
      meta: [
        { hid: 'description', name: 'description', content: 'Ask Me Anything! - tooget' }
      ]
    }
  },

  methods: {
    checkForm (e) {
      this.errors = []
      this.success = false

      if (!this.name) {
        this.errors.push("Name required")
      }
      if (!this.email) {
        this.errors.push('Email required')
      } else if (!this.validEmail(this.email)) {
        this.errors.push('Valid email required')
      }
      if (!this.message) {
        this.errors.push("Message required")
      }

      if (!this.errors.length) {
        this.submitForm()
      }

      e.preventDefault()
    },

    submitForm () {
      this.loading = true

      axios.post(process.env.contactUrl,
      JSON.stringify({
          form: {
            name: this.name,
            email: this.email,
            message: this.message
          }
        }),
      {
        headers: { 'Content-Type': 'application/json' }
      })
      .then(({ data }) => {
        this.loading = false

        if(data.error){
          this.errors.push(data.error)
        } else if(data.name && data.email && data.message) {
          this.name = this.email = this.message = null
          this.success = true
        }
      }).catch(error => {
        this.loading = false
        console.log(error)
        this.errors.push('An error occured, please try again later')
      })
    },

    validEmail (email) {
      // eslint-disable-next-line
      const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
      return re.test(email)
    }
  }
}
</script>